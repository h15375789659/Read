# 翻页模式问题记录

## 问题列表

### 问题1：上下滚动模式不应显示翻页动画选项
- **状态**: ✅ 已修复
- **描述**: 在翻页模式为"上下滚动"时，翻页动画选项仍然显示，但实际上上下滚动模式不需要翻页动画
- **修复方案**: 
  - 在布局文件中给翻页动画容器添加ID `page_animation_container`
  - 在 `ReaderSettingsDialog` 中添加 `updatePageAnimationVisibility()` 方法
  - 当翻页模式为上下滚动时隐藏翻页动画选项

### 问题2：左右翻页模式底部显示不全
- **状态**: ✅ 已修复（第三次修复）
- **描述**: 在左右翻页模式下，页面底部有大量空白，文字没有填满整个页面
- **原因分析**: 
  1. `PageContentView` 中的内边距使用固定像素值，而 `ReaderActivity` 中使用 dp 单位
  2. 标题下方间距计算不一致
  3. 二分查找边界条件处理不当
  4. `StaticLayout.getHeight()` 包含了最后一行的行间距，导致分页时每页放的文字比实际能显示的少
  5. 分页时创建的 `TextPaint` 没有设置用户选择的字体，导致字符宽度计算不一致
- **修复方案**: 
  - 修改 `PageContentView` 使用 dp 单位计算内边距
  - 统一 `TextPaginator` 和 `PageContentView` 中的标题间距计算
  - 优化二分查找算法，先检查剩余文本是否能全部放下
  - 添加 `getEffectiveHeight()` 方法计算不包含最后一行行间距的有效高度
  - 在 `ReaderActivity.paginateContent()` 中为 `TextPaint` 设置当前选择的字体

### 问题3：点击中间显示工具栏会回到第一页
- **状态**: ✅ 已修复
- **描述**: 在左右翻页模式下，点击屏幕中间区域显示工具栏时，页面会自动跳回到本章的第一页
- **原因**: `updateUI` 方法中每次都会调用 `paginateContent`，而 `paginateContent` 会重置到第一页
- **修复方案**: 
  - 添加 `lastPaginatedChapterId` 和 `lastPaginatedContent` 变量跟踪上次分页状态
  - 只有在章节ID或内容改变时才重新分页

### 问题4：翻页动画效果存在问题
- **状态**: ✅ 已修复
- **描述**: 各种翻页动画模式或多或少存在问题
- **修复方案**: 
  - 重写所有 PageTransformer 实现
  - 在每个动画开始时重置所有变换属性
  - 修复覆盖动画、滑动动画、仿真动画的逻辑

---

## 修复进度

- [x] 问题1 - 上下滚动模式隐藏翻页动画选项
- [x] 问题2 - 页面尽可能填满（第三次修复：修复行间距计算和字体一致性）
- [x] 问题3 - 点击工具栏不再回到第一页
- [x] 问题4 - 翻页动画效果修复
- [x] 问题5 - 阅读进度和设置保存（第四次修复：修复首次加载时页码恢复）
- [x] 问题11 - 字体设置生效（上下滚动模式字体应用）
- [x] 问题12 - 章节切换过于敏感（添加确认机制和冷却时间）

---

## 新问题列表

### 问题5：阅读进度和设置无法保存
- **状态**: ✅ 已修复（第四次修复）
- **描述**: 
  - 阅读到第五章第三页，退出后再次进入会回到第五章第一页
  - 上下滚动模式也有同样问题
  - 阅读设置（字体大小、行间距、主题等）无法保存
  - **新问题**：左右翻页模式下，设置改变后重新进入小说会变成上下翻页，所有设置恢复默认
- **原因分析**:
  1. 数据库只有一个 `currentPosition` 字段，但被用于两种不同的模式
  2. 上下滚动模式存储滚动位置（像素值，可能很大）
  3. 左右翻页模式存储页码索引（通常是小数字）
  4. 之前的代码将同一个值同时设置给两个字段，导致恢复位置不正确
  5. **根本原因1**：`ReaderSettingsDialog` 中的 `Spinner` 在设置监听器时会立即触发 `onItemSelected` 回调，导致设置被重置为默认值
  6. **根本原因2**：`updateState()` 使用 `postValue()` 是异步的，导致 Activity 观察时收到的是默认状态
  7. **根本原因3**：`switchPageMode()` 在首次加载时会重置 `needRestorePosition = false`，导致保存的页码无法恢复
- **修复方案**: 
  - 在 `ReaderUiState` 中添加 `savedScrollPosition` 和 `savedPageIndex` 字段
  - 在 `ReaderViewModel.loadNovel()` 中根据值的大小判断是滚动位置还是页码
  - 如果值 > 100，认为是滚动位置；否则认为是页码
  - 在 `ReaderActivity` 中根据模式恢复滚动位置或页码
  - 在 `onPause()` 中保存当前位置
  - **修复1**：在 `ReaderSettingsDialog` 中添加 `isInitializing` 标志，防止初始化时触发回调覆盖用户设置
  - **修复2**：在 `ReaderViewModel.initializeSettings()` 中使用 `setValue()` 同步更新初始状态
  - **修复3**：修改 `switchPageMode()` 逻辑，首次加载时保留 `needRestorePosition` 标志，允许恢复保存的页码

### 问题11：字体设置无效果
- **状态**: ✅ 已修复
- **描述**: 选择字体后，阅读界面的字体没有变化
- **原因分析**:
  1. `assets/fonts` 目录不存在，字体文件无法加载
  2. 上下滚动模式的 `chapterContentText` 和 `chapterTitleText` 没有设置字体
- **修复方案**: 
  - 创建 `assets/fonts` 目录并添加说明文件
  - 在 `ReaderActivity.updateUI()` 中为上下滚动模式的文本视图设置字体
  - 添加 `getTypefaceForFont()` 辅助方法加载字体

### 问题6：章节末尾无法自动跳转下一章
- **状态**: ✅ 已修复
- **描述**: 在章节末尾继续翻页/下滑无法自动跳转到下一章
- **修复方案**: 
  - 左右翻页模式：在 ViewPager2 的 `onPageScrollStateChanged` 中检测最后一页，自动加载下一章
  - 上下滚动模式：在 ScrollView 的触摸监听器中检测底部，自动加载下一章

### 问题7：夜间模式按钮位置调整
- **状态**: ✅ 已修复
- **描述**: 希望在工具栏右上角添加夜间模式切换按钮（月亮图标），去除自动切换功能
- **修复方案**: 
  - 在顶部工具栏添加夜间模式按钮 `btn_night_mode`
  - 创建月亮图标 `ic_night_mode.xml`
  - 添加 `toggleNightMode()` 方法切换日间/夜间模式
  - 移除设置对话框中的自动切换开关

### 问题8：添加字体选择功能
- **状态**: ✅ 已修复
- **描述**: 希望添加字体选择设置，提供几个常用字体
- **修复方案**: 
  - 创建 `ReaderFont` 枚举类，包含默认、宋体、楷体、黑体、仿宋
  - 在 `SettingsRepository` 中添加字体设置存储
  - 在设置对话框中添加字体选择 Spinner
  - 在 `PageContentView` 和 `PageAdapter` 中应用字体
  - 注意：需要在 assets/fonts 目录下添加对应的字体文件


### 问题9：章节识别出现重复
- **状态**: ✅ 已修复
- **描述**: 章节列表中同一个章节标题出现多次，例如"第八百五十五章 炼制"出现了3次
- **原因分析**: 
  1. 章节标题正则表达式太宽松，匹配到了正文中类似章节标题的文本
  2. 没有检测重复的章节编号
- **修复方案**: 
  - 添加章节标题长度限制（最大50个字符）
  - 添加 `isValidChapterTitle()` 方法进行更严格的验证
  - 添加 `extractChapterNumber()` 方法提取章节编号
  - 检测并跳过与上一个章节编号相同的行（可能是正文中的引用）


### 问题10：从上下滚动切换到左右翻页会跳到章节末尾
- **状态**: ✅ 已修复
- **描述**: 从上下滚动模式切换到左右翻页模式时，会自动跳转到本章节的最后一页
- **原因分析**: 
  - `switchPageMode` 方法中没有重置 `pendingPageIndex` 变量
  - `paginateContent` 方法中检查 `pendingPageIndex == -1 && !needRestorePosition` 时会跳转到最后一页
- **修复方案**: 
  - 在 `switchPageMode` 切换到左右翻页模式时，设置 `pendingPageIndex = 0` 和 `needRestorePosition = false`
  - 确保切换模式时从第一页开始显示

### 问题12：章节切换过于敏感
- **状态**: ✅ 已修复
- **描述**: 
  - 左右翻页模式：从倒数第二页到倒数第一页时立即跳转下一章，从第二页到第一页时立即跳转上一章
  - 上下滚动模式：到达底部时立即跳转下一章，无法返回上一章
  - 滑动力度要求过大
- **原因分析**:
  1. 左右翻页模式的 `onPageScrollStateChanged` 在检测到边界页面时立即触发章节切换
  2. 上下滚动模式在 `ACTION_UP` 时检测到边界就立即跳转
  3. 没有给用户确认的机会
- **修复方案**: 
  - 左右翻页模式：只有当用户在边界页面滑动后仍然停留在同一页面时才触发章节切换，添加1秒冷却时间防止重复触发
  - 上下滚动模式：改为"双击确认"机制，第一次滑动显示提示，500ms内再次滑动才触发章节切换
  - 上下滚动模式支持在顶部上滑返回上一章

### 问题13：左右翻页切换章节时无法显示翻页动画
- **状态**: ✅ 已修复
- **描述**: 在左右翻页模式下，切换章节时没有翻页动画效果，只是简单地跳转到新章节
- **原因分析**:
  1. 原来的实现在章节切换时只是调用 `setCurrentItem(0, true)`，但此时新章节内容还没加载完成
  2. ViewPager2 的 PageTransformer 只在页面间滑动时生效，无法在章节切换时触发
- **修复方案**: 
  - 预加载上一章和下一章的内容
  - 在 `ReaderUiState` 中添加 `previousChapter`、`nextChapter`、`previousChapterContent`、`nextChapterContent` 字段
  - 修改 `ReaderViewModel.loadChapter()` 和 `loadNovel()` 方法，同时加载相邻章节内容
  - 修改 `PageAdapter` 支持多章节页面：上一章最后一页 + 当前章节所有页 + 下一章第一页
  - 修改 `paginateContent()` 方法，分页时包含相邻章节的页面
  - 修改 ViewPager2 的页面切换监听器，检测翻到相邻章节页面时触发章节切换
  - 这样用户翻页时可以看到真正的翻页动画效果
